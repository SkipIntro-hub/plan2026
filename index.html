<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Acción 2026 | Analyzer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ========== LOGIN SCREEN ========== */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0f;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }
        #login-screen.hidden { display: none; }
        #main-content { display: none; }
        #main-content.visible { display: block; }
        .login-box {
            background: #12121a;
            border: 1px solid #2a2a3a;
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .login-box h2 {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.5rem;
            color: #f0f0f5;
            margin-bottom: 0.5rem;
        }
        .login-box p {
            color: #8888a0;
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }
        .login-box input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: #1a1a24;
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            color: #f0f0f5;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .login-box input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        .login-box button {
            width: 100%;
            padding: 0.85rem;
            background: #6366f1;
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-box button:hover { background: #5558e3; }
        .login-error {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 1rem;
            display: none;
        }
        /* ========== END LOGIN ========== */

        :root {
            --bg-deep: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a24;
            --border: #2a2a3a;
            --text-primary: #f0f0f5;
            --text-secondary: #8888a0;
            --text-muted: #55556a;
            --accent-fidelizacion: #00d4aa;
            --accent-relacionamiento: #6366f1;
            --accent-comunicacion: #f59e0b;
            --accent-branding: #ec4899;
            --accent-varios: #8b5cf6;
            --glow-fidelizacion: rgba(0, 212, 170, 0.15);
            --glow-relacionamiento: rgba(99, 102, 241, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            z-index: 9999;
        }

        header {
            padding: 2.5rem 3rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.08) 0%, transparent 100%);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .title-block h1 {
            font-size: 2.25rem;
            font-weight: 600;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
        }

        .title-block h1 span {
            background: linear-gradient(135deg, var(--accent-relacionamiento), var(--accent-fidelizacion));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title-block p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .kpi-strip {
            display: flex;
            gap: 2.5rem;
        }

        .kpi {
            text-align: right;
        }

        .kpi-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .kpi-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem 3rem 4rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
        }

        .filter-buttons {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            max-width: 600px;
        }

        .filter-btn {
            padding: 0.5rem 0.85rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-btn:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .filter-btn.active {
            background: var(--accent-relacionamiento);
            color: white;
        }

        .search-group {
            flex: 1;
            min-width: 280px;
            max-width: 400px;
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.65rem 1rem 0.65rem 2.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-relacionamiento);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 0.85rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-clear {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-elevated);
            border: none;
            color: var(--text-secondary);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .search-clear.visible {
            display: flex;
        }

        .search-clear:hover {
            background: var(--accent-relacionamiento);
            color: white;
        }

        .active-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .active-filters:empty {
            display: none;
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.6rem 0.35rem 0.8rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .filter-tag-remove {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--border);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            transition: all 0.2s ease;
        }

        .filter-tag-remove:hover {
            background: var(--accent-relacionamiento);
            color: white;
        }

        .results-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .results-count strong {
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
        }

        .highlight {
            background: rgba(99, 102, 241, 0.3);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Input editable en tabla */
        .editable-input {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            width: 110px;
            padding: 6px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .editable-input:hover {
            border-color: var(--border);
            background: var(--bg-elevated);
        }
        
        .editable-input:focus {
            border-color: var(--accent-relacionamiento);
            background: var(--bg-elevated);
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        /* Botón Export */
        .btn-export {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-export:hover {
            background: var(--accent-fidelizacion);
            border-color: var(--accent-fidelizacion);
            color: white;
        }

        .btn-export svg {
            width: 16px;
            height: 16px;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 520px;
            padding: 2rem;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-muted);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--accent-relacionamiento);
            border-color: var(--accent-relacionamiento);
            color: white;
        }

        .modal-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .modal-header .modal-gestion-badge {
            display: inline-block;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
        }

        .modal-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.85rem 0;
            border-bottom: 1px solid var(--border);
        }

        .modal-row:last-child {
            border-bottom: none;
        }

        .modal-row-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .modal-row-value {
            font-family: 'Space Mono', monospace;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .modal-row.total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border);
            border-bottom: none;
        }

        .modal-row.total .modal-row-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-row.total .modal-row-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-relacionamiento);
        }

        .modal-gantt {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .modal-gantt-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .modal-gantt-bar {
            display: flex;
            gap: 3px;
        }

        .modal-gantt-month {
            flex: 1;
            height: 28px;
            background: var(--bg-elevated);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .modal-gantt-month.active {
            background: var(--accent-relacionamiento);
            color: white;
            font-weight: 500;
        }

        .modal-gantt-month.tentative {
            background: repeating-linear-gradient(
                45deg,
                var(--bg-elevated),
                var(--bg-elevated) 2px,
                var(--border) 2px,
                var(--border) 4px
            );
        }

        /* Modal de detalle mensual */
        .month-modal-total {
            font-family: 'Space Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-relacionamiento);
        }

        .month-modal-chart-container {
            height: 250px;
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .month-modal-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .month-modal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .month-modal-item:hover {
            background: var(--bg-elevated);
        }

        .month-modal-item:last-child {
            border-bottom: none;
        }

        .month-modal-item-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .month-modal-item-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .month-modal-item-name {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .month-modal-item-gestion {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        .month-modal-item-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-right: 1rem;
        }

        .month-modal-item-percent {
            font-size: 0.75rem;
            color: var(--text-secondary);
            min-width: 45px;
            text-align: right;
        }

        .chart-click-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Edición inline en modal */
        .modal-editable {
            background: transparent;
            border: 1px solid transparent;
            color: var(--accent-relacionamiento);
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            width: 150px;
            padding: 4px 8px;
            border-radius: 6px;
            text-align: right;
            transition: all 0.2s ease;
        }

        .modal-editable:hover {
            border-color: var(--border);
            background: var(--bg-elevated);
        }

        .modal-editable:focus {
            border-color: var(--accent-relacionamiento);
            background: var(--bg-elevated);
            outline: none;
        }

        .view-toggle {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .view-btn:hover, .view-btn.active {
            background: var(--accent-relacionamiento);
            color: white;
            border-color: var(--accent-relacionamiento);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
            min-width: 0;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .summary-card h3 {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-item:hover {
            padding-left: 0.5rem;
        }

        .breakdown-item.selected {
            background: var(--bg-elevated);
            margin: 0 -1.25rem;
            padding: 0.6rem 1.25rem;
            border-radius: 6px;
        }

        .breakdown-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .breakdown-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .breakdown-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .breakdown-bar {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 0.4rem;
            overflow: hidden;
        }

        .breakdown-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 0;
            overflow: visible;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }

        .activity-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .activity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .activity-card.fidelizacion::before { background: var(--accent-fidelizacion); }
        .activity-card.relacionamiento::before { background: var(--accent-relacionamiento); }
        .activity-card.comunicacion::before { background: var(--accent-comunicacion); }
        .activity-card.branding::before { background: var(--accent-branding); }
        .activity-card.varios::before { background: var(--accent-varios); }

        .activity-card:hover {
            transform: translateY(-2px);
            border-color: var(--text-muted);
        }

        .activity-card.fidelizacion:hover { box-shadow: 0 8px 32px var(--glow-fidelizacion); }
        .activity-card.relacionamiento:hover { box-shadow: 0 8px 32px var(--glow-relacionamiento); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .card-type {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .card-investment {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .fidelizacion .card-investment { color: var(--accent-fidelizacion); }
        .relacionamiento .card-investment { color: var(--accent-relacionamiento); }
        .comunicacion .card-investment { color: var(--accent-comunicacion); }
        .branding .card-investment { color: var(--accent-branding); }
        .varios .card-investment { color: var(--accent-varios); }

        .card-title {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .card-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .card-meta span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .gantt-mini {
            display: flex;
            gap: 2px;
            margin-top: 0.75rem;
        }

        .gantt-month {
            flex: 1;
            height: 20px;
            background: var(--bg-elevated);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .gantt-month.active {
            background: var(--accent-relacionamiento);
            color: white;
        }

        .gantt-month.tentative {
            background: repeating-linear-gradient(
                45deg,
                var(--bg-elevated),
                var(--bg-elevated) 2px,
                var(--border) 2px,
                var(--border) 4px
            );
        }

        .gantt-month.ondemand {
            background: var(--bg-elevated);
            border: 1px dashed var(--text-muted);
        }

        .fidelizacion .gantt-month.active { background: var(--accent-fidelizacion); }
        .comunicacion .gantt-month.active { background: var(--accent-comunicacion); }
        .branding .gantt-month.active { background: var(--accent-branding); }
        .varios .gantt-month.active { background: var(--accent-varios); }

        /* Table View */
        .table-view {
            display: none;
        }

        .table-view.active {
            display: block;
        }

        .activity-grid.hidden {
            display: none;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-elevated);
            padding: 1rem;
            text-align: left;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 0.875rem 1rem;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: var(--bg-elevated);
        }

        .gestion-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .gestion-badge.fidelizacion { background: rgba(0, 212, 170, 0.15); color: var(--accent-fidelizacion); }
        .gestion-badge.relacionamiento { background: rgba(99, 102, 241, 0.15); color: var(--accent-relacionamiento); }
        .gestion-badge.comunicacion { background: rgba(245, 158, 11, 0.15); color: var(--accent-comunicacion); }
        .gestion-badge.branding { background: rgba(236, 72, 153, 0.15); color: var(--accent-branding); }
        .gestion-badge.varios { background: rgba(139, 92, 246, 0.15); color: var(--accent-varios); }

        .investment-cell {
            font-family: 'Space Mono', monospace;
            font-weight: 600;
        }

        .percentage-bar {
            width: 60px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }

        .percentage-bar-fill {
            height: 100%;
            background: var(--accent-relacionamiento);
            border-radius: 2px;
        }

        /* Month View - Calendario Horizontal */
        .month-view {
            display: none;
        }

        .month-view.active {
            display: block;
            width: 100%;
            overflow-x: auto;
        }

        .month-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .month-view-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .month-view-total {
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            color: var(--accent-relacionamiento);
        }

        .month-view-totals {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .month-view-total-item {
            text-align: right;
        }

        .month-view-total-label {
            display: block;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .month-view-total-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .month-view-total-value.confirmed {
            color: var(--accent-fidelizacion);
        }

        .month-view-total-value.pending {
            color: var(--accent-comunicacion);
        }

        .month-scroll-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: visible;
            padding-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-relacionamiento) var(--bg-elevated);
        }

        .month-scroll-container::-webkit-scrollbar {
            height: 10px;
        }

        .month-scroll-container::-webkit-scrollbar-track {
            background: var(--bg-elevated);
            border-radius: 5px;
        }

        .month-scroll-container::-webkit-scrollbar-thumb {
            background: var(--accent-relacionamiento);
            border-radius: 5px;
        }

        .month-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent-fidelizacion);
        }

        .month-grid {
            display: flex;
            gap: 0.75rem;
            width: max-content;
            padding: 0.25rem;
        }

        .month-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            width: 220px;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .month-card:hover {
            border-color: var(--text-muted);
        }

        .month-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .month-card h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .month-card .month-index {
            font-size: 0.65rem;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .month-card .month-total {
            font-family: 'Space Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-relacionamiento);
            margin-bottom: 0.5rem;
        }

        .month-card .month-total-tentative {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .month-card .month-count {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .month-card .month-accumulated {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            padding: 0.3rem 0.5rem;
            background: var(--bg-elevated);
            border-radius: 4px;
            display: inline-block;
        }

        .month-activities {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            max-height: 320px;
            overflow-y: auto;
        }

        .month-activities::-webkit-scrollbar {
            width: 4px;
        }

        .month-activities::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .month-activity {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.7rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .month-activity:hover {
            background: var(--border);
        }

        .month-activity.tentative {
            border-left: 2px dashed var(--text-muted);
            opacity: 0.7;
        }

        .month-activity-info {
            flex: 1;
            min-width: 0;
        }

        .month-activity-name {
            color: var(--text-secondary);
            line-height: 1.3;
            word-wrap: break-word;
        }

        .month-activity-value {
            font-family: 'Space Mono', monospace;
            color: var(--text-primary);
            white-space: nowrap;
            font-size: 0.75rem;
        }

        .month-activity-badge {
            font-size: 0.55rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            text-transform: uppercase;
            margin-top: 0.25rem;
            display: inline-block;
        }

        .month-activity-badge.fidelizacion { background: rgba(0, 212, 170, 0.15); color: var(--accent-fidelizacion); }
        .month-activity-badge.relacionamiento { background: rgba(99, 102, 241, 0.15); color: var(--accent-relacionamiento); }
        .month-activity-badge.comunicacion { background: rgba(245, 158, 11, 0.15); color: var(--accent-comunicacion); }
        .month-activity-badge.branding { background: rgba(236, 72, 153, 0.15); color: var(--accent-branding); }
        .month-activity-badge.varios { background: rgba(139, 92, 246, 0.15); color: var(--accent-varios); }

        .month-empty {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-align: center;
            padding: 1rem;
        }

        .scroll-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .scroll-hint svg {
            animation: scrollHint 1.5s ease-in-out infinite;
        }

        @keyframes scrollHint {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .summary-card {
                flex: 1;
                min-width: 250px;
            }
        }

        /* Charts Section */
        .charts-section {
            margin-bottom: 2rem;
        }

        .charts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .charts-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
        }

        .chart-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .chart-tab {
            padding: 0.4rem 0.75rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-tab:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .chart-tab.active {
            background: var(--accent-relacionamiento);
            color: white;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card h4 {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .chart-card .chart-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        .chart-container.small {
            height: 240px;
        }

        .chart-legend-custom {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .chart-insight {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-elevated);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .insight-icon {
            width: 32px;
            height: 32px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-relacionamiento);
        }

        .insight-text {
            flex: 1;
        }

        .insight-text strong {
            display: block;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 0.15rem;
        }

        .insight-text span {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .cumulative-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .cum-stat {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .cum-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .cum-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 1.5rem;
            }
            
            main {
                padding: 1.5rem;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .kpi-strip {
                width: 100%;
                justify-content: space-between;
            }
            
            .activity-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .view-toggle {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>Plan de Acción 2026</h2>
            <p>Ingresá la contraseña para acceder</p>
            <input type="password" id="password-input" placeholder="Contraseña" onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Ingresar</button>
            <div class="login-error" id="login-error">Contraseña incorrecta</div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-content">
    <div class="noise-overlay"></div>
    
    <header>
        <div class="header-content">
            <div class="title-block">
                <h1>Plan de Acción <span>2026</span></h1>
                </div>
            <div class="kpi-strip">
                <div class="kpi">
                    <div class="kpi-value" id="total-investment">$1.446.600</div>
                    <div class="kpi-label">Inversión Total</div>
                </div>
                <div class="kpi">
                    <div class="kpi-value" id="total-activities">45</div>
                    <div class="kpi-label">Actividades</div>
                </div>
                <div class="kpi">
                    <div class="kpi-value" id="avg-monthly">$120.550</div>
                    <div class="kpi-label">Promedio Mensual</div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="controls">
            <div class="filter-group">
                <span class="filter-label">Gestión</span>
                <div class="filter-buttons" id="gestion-filter">
                    <button class="filter-btn active" data-filter="all">Todas</button>
                    <button class="filter-btn" data-filter="fidelizacion">Fidelización</button>
                    <button class="filter-btn" data-filter="relacionamiento">Relacionamiento</button>
                    <button class="filter-btn" data-filter="comunicacion">Comunicación</button>
                    <button class="filter-btn" data-filter="branding">Branding</button>
                    <button class="filter-btn" data-filter="varios">Varios</button>
                </div>
            </div>
            <div class="filter-group">
                <span class="filter-label">Tipo</span>
                <div class="filter-buttons" id="tipo-filter">
                    <button class="filter-btn active" data-filter="all">Todos</button>
                    <button class="filter-btn" data-filter="evento-mayor">Evento Mayor</button>
                    <button class="filter-btn" data-filter="evento-menor">Evento Menor</button>
                    <button class="filter-btn" data-filter="sponsoreo-mayor">Sponsoreo Mayor</button>
                    <button class="filter-btn" data-filter="sponsoreo-menor">Sponsoreo Menor</button>
                    <button class="filter-btn" data-filter="networking">Networking</button>
                    <button class="filter-btn" data-filter="sales">Sales</button>
                    <button class="filter-btn" data-filter="research">Research</button>
                    <button class="filter-btn" data-filter="pr">PR</button>
                    <button class="filter-btn" data-filter="produccion">Producción</button>
                    <button class="filter-btn" data-filter="content">Content</button>
                    <button class="filter-btn" data-filter="pauta">Pauta</button>
                </div>
            </div>
            <div class="filter-group">
                <span class="filter-label">Frecuencia</span>
                <div class="filter-buttons" id="frecuencia-filter">
                    <button class="filter-btn active" data-filter="all">Todas</button>
                    <button class="filter-btn" data-filter="anual">Anual</button>
                    <button class="filter-btn" data-filter="semestral">Semestral</button>
                    <button class="filter-btn" data-filter="trimestral">Trimestral</button>
                    <button class="filter-btn" data-filter="bimestral">Bimestral</button>
                    <button class="filter-btn" data-filter="mensual">Mensual</button>
                    <button class="filter-btn" data-filter="continuo">Continuo</button>
                    <button class="filter-btn" data-filter="eventual">Eventual</button>
                    <button class="filter-btn" data-filter="ondemand">On Demand</button>
                </div>
            </div>
            <div class="filter-group search-group">
                <span class="filter-label">Buscar Actividad</span>
                <div class="search-wrapper">
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" class="search-input" id="activity-search" placeholder="Buscar por nombre de actividad...">
                    <button class="search-clear" id="search-clear">✕</button>
                </div>
            </div>
            <button class="btn-export" id="btn-export" title="Exportar datos a CSV">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exportar CSV
                </button>
            <div class="view-toggle">
                <button class="view-btn active" data-view="cards" title="Vista tarjetas">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
                    </svg>
                </button>
                <button class="view-btn" data-view="table" title="Vista tabla">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <button class="view-btn" data-view="months" title="Vista mensual">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                </button>
            </div>
        </div>
            <div class="active-filters" id="active-filters"></div>
        </div>

        <div class="charts-section">
            <div class="charts-header">
                <span class="charts-title">Análisis Visual del Presupuesto</span>
                <div class="chart-tabs">
                    <button class="chart-tab active" data-chart="monthly">Mensual</button>
                    <button class="chart-tab" data-chart="cumulative">Acumulado</button>
                    <button class="chart-tab" data-chart="comparison">Comparativo</button>
                </div>
            </div>
            
            <!-- Monthly View Charts -->
            <div class="charts-grid" id="charts-monthly">
                <div class="chart-card">
                    <h4>Inversión Mensual por Gestión</h4>
                    <p class="chart-subtitle">Distribución del presupuesto a lo largo del año</p>
                    <div class="chart-container">
                        <canvas id="monthlyStackedChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Composición Total</h4>
                    <p class="chart-subtitle">Peso relativo por gestión</p>
                    <div class="chart-container small">
                        <canvas id="gestionPieChart"></canvas>
                    </div>
                    <div class="chart-insight">
                        <div class="insight-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                            </svg>
                        </div>
                        <div class="insight-text">
                            <strong id="top-gestion-insight">Relacionamiento domina</strong>
                            <span id="top-gestion-detail">Mayor inversión anual</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cumulative View Charts -->
            <div class="charts-grid" id="charts-cumulative" style="display: none;">
                <div class="chart-card full-width">
                    <div class="cumulative-stats">
                        <div class="cum-stat">
                            <div class="cum-stat-value" id="q1-total">$0</div>
                            <div class="cum-stat-label">Q1 (Ene-Mar)</div>
                        </div>
                        <div class="cum-stat">
                            <div class="cum-stat-value" id="h1-total">$0</div>
                            <div class="cum-stat-label">H1 (Ene-Jun)</div>
                        </div>
                        <div class="cum-stat">
                            <div class="cum-stat-value" id="year-total">$0</div>
                            <div class="cum-stat-label">Año Completo</div>
                        </div>
                    </div>
                    <h4>Inversión Acumulada</h4>
                    <p class="chart-subtitle">Evolución del gasto acumulado vs presupuesto total</p>
                    <div class="chart-container">
                        <canvas id="cumulativeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Comparison View Charts -->
            <div class="charts-grid" id="charts-comparison" style="display: none;">
                <div class="chart-card">
                    <h4>Inversión por Tipo de Actividad</h4>
                    <p class="chart-subtitle">Ranking de categorías por presupuesto</p>
                    <div class="chart-container">
                        <canvas id="tipoBarChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Frecuencia vs Inversión</h4>
                    <p class="chart-subtitle">Relación entre periodicidad y gasto</p>
                    <div class="chart-container small">
                        <canvas id="frequencyChart"></canvas>
                    </div>
                    <div class="chart-insight">
                        <div class="insight-icon" style="background: rgba(0, 212, 170, 0.15); color: var(--accent-fidelizacion);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div class="insight-text">
                            <strong id="freq-insight">Eventos anuales concentran inversión</strong>
                            <span id="freq-detail">Alto impacto, baja frecuencia</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <aside class="sidebar">
                <div class="summary-card">
                    <h3>Por Gestión</h3>
                    <div id="gestion-breakdown"></div>
                </div>
                <div class="summary-card">
                    <h3>Por Tipo</h3>
                    <div id="tipo-breakdown"></div>
                </div>
                <div class="summary-card">
                    <h3>Por Frecuencia</h3>
                    <div id="frecuencia-breakdown"></div>
                </div>
            </aside>

            <div class="content-area">
                <div class="activity-grid" id="activity-grid"></div>
                <div class="table-view" id="table-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Gestión</th>
                                <th>Tipo</th>
                                <th>Actividad</th>
                                <th>Frecuencia</th>
                                <th>Inversión</th>
                                <th>% del Total</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
                <div class="month-view" id="month-view">
                    <div class="month-view-header">
                        <div>
                            <span class="month-view-title">Distribución Mensual del Presupuesto</span>
                            <div class="scroll-hint">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                                Deslizá horizontalmente para ver todos los meses
                            </div>
                        </div>
                        <div class="month-view-totals">
                            <div class="month-view-total-item">
                                <span class="month-view-total-label">Presupuesto Total</span>
                                <span class="month-view-total-value" id="month-budget-total">$1.450.000</span>
                            </div>
                            <div class="month-view-total-item">
                                <span class="month-view-total-label">Confirmado</span>
                                <span class="month-view-total-value confirmed" id="month-confirmed-total">$0</span>
                            </div>
                            <div class="month-view-total-item">
                                <span class="month-view-total-label">Eventual (sin fecha)</span>
                                <span class="month-view-total-value pending" id="month-eventual-total">$0</span>
                            </div>
                        </div>
                    </div>
                    <div class="month-scroll-container">
                        <div class="month-grid" id="month-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Detalle -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <div class="modal-header">
                <h2 id="modal-title">Título de Actividad</h2>
                <span class="modal-gestion-badge" id="modal-gestion-badge">GESTIÓN</span>
            </div>
            <div class="modal-row">
                <span class="modal-row-label">Tipo</span>
                <span class="modal-row-value" id="modal-tipo">--</span>
            </div>
            <div class="modal-row">
                <span class="modal-row-label">Frecuencia</span>
                <span class="modal-row-value" id="modal-frecuencia">--</span>
            </div>
            <div class="modal-row">
                <span class="modal-row-label">Costo Unitario</span>
                <span class="modal-row-value" id="modal-unidad">--</span>
            </div>
            <div class="modal-row">
                <span class="modal-row-label">Cantidad / Repeticiones</span>
                <span class="modal-row-value" id="modal-cantidad">--</span>
            </div>
            <div class="modal-row total">
                <span class="modal-row-label">Inversión Total</span>
                <input type="number" class="modal-editable" id="modal-inversion" value="0">
            </div>
            <div class="modal-gantt">
                <div class="modal-gantt-label">Distribución Mensual</div>
                <div class="modal-gantt-bar" id="modal-gantt"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalle Mensual (zoom de barra) -->
    <div class="modal-overlay" id="month-detail-modal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close" onclick="closeMonthModal()">×</button>
            <div class="modal-header">
                <h2 id="month-modal-title">Detalle de Mes</h2>
                <span class="month-modal-total" id="month-modal-total">$0</span>
            </div>
            <div class="month-modal-chart-container">
                <canvas id="monthDetailChart"></canvas>
            </div>
            <div class="month-modal-list" id="month-modal-list"></div>
        </div>
    </div>

    <script>
        const activities = [
            { id: 1, gestion: "FIDELIZACION", tipo: "EVENTO MAYOR", actividad: "ATP", frecuencia: "1- ANUAL", meses: [0,1,0,0,0,0,0,0,0,0,0,0], unidad: 25000, cantidad: 1, inversion: 25000 },
            { id: 2, gestion: "FIDELIZACION", tipo: "EVENTO MAYOR", actividad: "MOVISTAR ARENA (SHOWS)", frecuencia: "7- CONTINUO/SEMANAL", meses: [1,1,1,1,1,1,1,1,1,1,1,1], unidad: 140000, cantidad: 1, inversion: 140000 },
            { id: 3, gestion: "RELACIONAMIENTO", tipo: "EVENTO MAYOR", actividad: "EVENTO SUMMIT", frecuencia: "1- ANUAL", meses: [0,0,0,0,1,0,0,0,0,0,0,0], unidad: 200000, cantidad: 1, inversion: 200000 },
            { id: 4, gestion: "RELACIONAMIENTO", tipo: "EVENTO MAYOR", actividad: "SKI BARILOCHE", frecuencia: "1- ANUAL", meses: [0,0,0,0,0,0,0,1,0,0,0,0], unidad: 25000, cantidad: 1, inversion: 25000 },
            { id: 5, gestion: "RELACIONAMIENTO", tipo: "EVENTO MAYOR", actividad: "EVENTO SEGUROS (+ ESTADÍA + ALMUERZO VIP)", frecuencia: "1- ANUAL", meses: [0,0,0,0,0,0,0,0,1,0,0,0], unidad: 100000, cantidad: 1, inversion: 100000 },
            { id: 6, gestion: "FIDELIZACION", tipo: "EVENTO MAYOR", actividad: "EVENTO DE FIN DE AÑO CLIENTES", frecuencia: "1- ANUAL", meses: [0,0,0,0,0,0,0,0,0,0,0,1], unidad: 200000, cantidad: 1, inversion: 200000 },
            { id: 7, gestion: "FIDELIZACION", tipo: "EVENTO MENOR", actividad: "EVENTO FIN DE AÑO FAMILY & FRIENDS", frecuencia: "1- ANUAL", meses: [0,0,0,0,0,0,0,0,0,0,0,1], unidad: 30000, cantidad: 1, inversion: 30000 },
            { id: 8, gestion: "RELACIONAMIENTO", tipo: "EVENTO MENOR", actividad: "AFTER OFFICE (EXTERNO)", frecuencia: "4- BIMESTRAL", meses: [0,1,0,1,0,1,0,1,0,1,0,0], unidad: 5000, cantidad: 5, inversion: 25000 },
            { id: 9, gestion: "RELACIONAMIENTO", tipo: "EVENTO MENOR", actividad: "AFTER OFFICE (OFICINA)(CATAS)", frecuencia: "4- BIMESTRAL", meses: [0,0,1,0,1,0,1,0,1,0,1,0], unidad: 7000, cantidad: 5, inversion: 35000 },
            { id: 10, gestion: "RELACIONAMIENTO", tipo: "EVENTO MENOR", actividad: "ALMUERZOS OFICINA (SPEAKER)", frecuencia: "5- MENSUAL", meses: [0,0,1,1,1,1,1,1,1,1,1,0], unidad: 5000, cantidad: 9, inversion: 45000 },
            { id: 11, gestion: "RELACIONAMIENTO", tipo: "EVENTO MENOR", actividad: "EVENTOS PROPIOS INTERIOR (DESAYUNOS, CENAS)", frecuencia: "5- MENSUAL", meses: [0,0,1,1,1,1,1,1,1,1,1,1], unidad: 4000, cantidad: 10, inversion: 40000 },
            { id: 12, gestion: "RELACIONAMIENTO", tipo: "EVENTO MENOR", actividad: "ALMUERZOS OFICINA (COMERCIAL)", frecuencia: "7- CONTINUO/SEMANAL", meses: [0,0,1,1,1,1,1,1,1,1,1,0], unidad: 500, cantidad: 72, inversion: 36000 },
            { id: 13, gestion: "RELACIONAMIENTO", tipo: "EVENTO MENOR", actividad: "CENAS EXCLUSIVAS (CASA VG + CENAS PREVIAS SUMMIT Y SEGUROS)", frecuencia: "3- TRIMESTRAL", meses: [0,0,1,0,0,1,0,0,1,0,0,0], unidad: 10000, cantidad: 3, inversion: 30000 },
            { id: 14, gestion: "RELACIONAMIENTO", tipo: "EVENTO MENOR", actividad: "WEEKENDS EXCLUSIVOS (VINOS MZA)", frecuencia: "8- EVENTUAL", meses: [0,0,0,2,0,0,0,0,2,0,0,0], unidad: 10000, cantidad: 2, inversion: 20000, tentative: true },
            { id: 15, gestion: "RELACIONAMIENTO", tipo: "EVENTO MENOR", actividad: "EVENTO MUJERES", frecuencia: "2- SEMESTRAL", meses: [0,0,0,1,0,0,0,0,0,1,0,0], unidad: 10000, cantidad: 2, inversion: 20000 },
            { id: 16, gestion: "FIDELIZACION", tipo: "EVENTO MENOR", actividad: "CLÍNICA DE TENIS/ PADEL", frecuencia: "2- SEMESTRAL", meses: [0,0,1,0,0,0,0,0,0,1,0,0], unidad: 10000, cantidad: 2, inversion: 20000 },
            { id: 17, gestion: "RELACIONAMIENTO", tipo: "EVENTO MENOR", actividad: "ALMUERZOS ESPECIALES (EXTERNOS)(SPEAKER) (MECON)", frecuencia: "2- SEMESTRAL", meses: [0,0,0,0,0,1,0,0,0,0,0,1], unidad: 10000, cantidad: 2, inversion: 20000 },
            { id: 18, gestion: "FIDELIZACION", tipo: "EVENTO MENOR", actividad: "WAKE BOARD", frecuencia: "8- EVENTUAL", meses: [0,0,0,0,0,0,0,0,0,0,2,2], unidad: 3000, cantidad: 2, inversion: 6000, tentative: true },
            { id: 19, gestion: "RELACIONAMIENTO", tipo: "SPONSOREO MAYOR", actividad: "IAEF - CONGRESO ANUAL (CEC)", frecuencia: "1- ANUAL", meses: [0,0,0,0,0,1,0,0,0,0,0,0], unidad: 15000, cantidad: 1, inversion: 15000 },
            { id: 20, gestion: "RELACIONAMIENTO", tipo: "SPONSOREO MAYOR", actividad: "IAEF - CENA PROPIA (EN CONVENCIÓN)", frecuencia: "1- ANUAL", meses: [0,0,0,0,0,0,0,0,1,0,0,0], unidad: 25000, cantidad: 1, inversion: 25000 },
            { id: 21, gestion: "RELACIONAMIENTO", tipo: "SPONSOREO MAYOR", actividad: "IAEF - CONVENCIÓN ANUAL (INTERIOR)", frecuencia: "1- ANUAL", meses: [0,0,0,0,0,0,0,0,1,0,0,0], unidad: 50000, cantidad: 1, inversion: 50000 },
            { id: 22, gestion: "RELACIONAMIENTO", tipo: "SPONSOREO MENOR", actividad: "EXPOS (SECTORES PRODUCTIVOS)", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 20000, cantidad: 1, inversion: 20000, tentative: true },
            { id: 23, gestion: "RELACIONAMIENTO", tipo: "SPONSOREO MENOR", actividad: "SPONSOREOS VARIOS (WEF, AGEI, CAJAS, MINERÍA)", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 20000, cantidad: 1, inversion: 20000, tentative: true },
            { id: 24, gestion: "FIDELIZACION", tipo: "ACCIONES NETWORKING", actividad: "FUTBOL", frecuencia: "7- CONTINUO/SEMANAL", meses: [1,1,1,1,1,1,1,1,1,1,1,1], unidad: 500, cantidad: 48, inversion: 24000 },
            { id: 25, gestion: "FIDELIZACION", tipo: "ACCIONES NETWORKING", actividad: "PADDLE", frecuencia: "7- CONTINUO/SEMANAL", meses: [1,1,1,1,1,1,1,1,1,1,1,1], unidad: 250, cantidad: 48, inversion: 12000 },
            { id: 26, gestion: "FIDELIZACION", tipo: "ACCIONES NETWORKING", actividad: "TENIS", frecuencia: "7- CONTINUO/SEMANAL", meses: [1,1,1,1,1,1,1,1,1,1,1,1], unidad: 250, cantidad: 48, inversion: 12000 },
            { id: 27, gestion: "RELACIONAMIENTO", tipo: "ACCIONES NETWORKING", actividad: "AMCHAM", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 5000, cantidad: 1, inversion: 5000, tentative: true },
            { id: 28, gestion: "RELACIONAMIENTO", tipo: "ACCIONES NETWORKING", actividad: "CÁMARA FINTECH", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 5000, cantidad: 1, inversion: 5000, tentative: true },
            { id: 29, gestion: "RELACIONAMIENTO", tipo: "ACCIONES NETWORKING", actividad: "CÁMARA MINERÍA", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 5000, cantidad: 1, inversion: 5000, tentative: true },
            { id: 30, gestion: "RELACIONAMIENTO", tipo: "ACCIONES NETWORKING", actividad: "CÁMARA OIL & GAS", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 5000, cantidad: 1, inversion: 5000, tentative: true },
            { id: 31, gestion: "RELACIONAMIENTO", tipo: "ACCIONES NETWORKING", actividad: "IDEA", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 10000, cantidad: 1, inversion: 10000, tentative: true },
            { id: 32, gestion: "RELACIONAMIENTO", tipo: "ACCIONES NETWORKING", actividad: "SOMOS PYMES", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 5000, cantidad: 1, inversion: 5000, tentative: true },
            { id: 33, gestion: "RELACIONAMIENTO", tipo: "ACCIONES SALES", actividad: "DESAYUNOS OFICINA (COMERCIAL)", frecuencia: "6- QUINCENAL", meses: [0,0,1,1,1,1,1,1,1,1,0,0], unidad: 300, cantidad: 72, inversion: 21600 },
            { id: 34, gestion: "RELACIONAMIENTO", tipo: "ACCIONES SALES", actividad: "DESAYUNOS OFICINA (TÉCNICO)", frecuencia: "6- QUINCENAL", meses: [0,0,1,1,1,1,1,1,1,1,0,0], unidad: 500, cantidad: 36, inversion: 18000 },
            { id: 35, gestion: "FIDELIZACION", tipo: "ACCIONES RESEARCH", actividad: "WEBINAR MENSUAL", frecuencia: "5- MENSUAL", meses: [1,1,1,1,1,1,1,1,1,1,1,1], unidad: 0, cantidad: 12, inversion: 0 },
            { id: 36, gestion: "FIDELIZACION", tipo: "ACCIONES RESEARCH", actividad: "WEBINARS ESPECIALES", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 0, cantidad: 1, inversion: 0, tentative: true },
            { id: 37, gestion: "FIDELIZACION", tipo: "ACCIONES PR", actividad: "COLÓN/RIVER/BOCA", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 1000, cantidad: 12, inversion: 12000, tentative: true },
            { id: 38, gestion: "FIDELIZACION", tipo: "ACCIONES PR", actividad: "INVITACIONES ESPECIALES (RECITALES, PALCOS)", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 1000, cantidad: 12, inversion: 12000, tentative: true },
            { id: 39, gestion: "FIDELIZACION", tipo: "ACCIONES PR", actividad: "DÍA DEL/LA...", frecuencia: "8- EVENTUAL", meses: [2,2,2,2,2,2,2,2,2,2,2,2], unidad: 10000, cantidad: 1, inversion: 10000, tentative: true },
            { id: 40, gestion: "FIDELIZACION", tipo: "ACCIONES PR", actividad: "REGALOS ONGOING (PICADAS, DESAYUNOS, OTROS)", frecuencia: "9- ONDEMAND", meses: [3,3,3,3,3,3,3,3,3,3,3,3], unidad: 10000, cantidad: 1, inversion: 10000, ondemand: true },
            { id: 41, gestion: "COMUNICACIÓN", tipo: "CONTENT", actividad: "POSTEOS", frecuencia: "7- CONTINUO/SEMANAL", meses: [1,1,1,1,1,1,1,1,1,1,1,1], unidad: 1000, cantidad: 12, inversion: 12000 },
            { id: 42, gestion: "COMUNICACIÓN", tipo: "PAUTA", actividad: "GOOGLE ADS/ LINKEDIN/ OTROS", frecuencia: "7- CONTINUO/SEMANAL", meses: [1,1,1,1,1,1,1,1,1,1,1,1], unidad: 3000, cantidad: 12, inversion: 36000 },
            { id: 43, gestion: "BRANDING", tipo: "PRODUCCION", actividad: "MATERIALES VARIOS", frecuencia: "9- ONDEMAND", meses: [3,3,3,3,3,3,3,3,3,3,3,3], unidad: 35000, cantidad: 1, inversion: 35000, ondemand: true },
            { id: 44, gestion: "FIDELIZACION", tipo: "PRODUCCION", actividad: "REGALOS DE FIN DE AÑO", frecuencia: "1- ANUAL", meses: [0,0,0,0,0,0,0,0,0,0,1,0], unidad: 50000, cantidad: 1, inversion: 50000 },
            { id: 45, gestion: "VARIOS", tipo: "VARIOS", actividad: "TBD", frecuencia: "9- ONDEMAND", meses: [3,3,3,3,3,3,3,3,3,3,3,3], unidad: 3400, cantidad: 1, inversion: 3400, ondemand: true }
        ];

        const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        let totalInversion = 1446600;

        let currentFilters = {
            gestion: 'all',
            tipo: 'all',
            frecuencia: 'all',
            search: ''
        };

        let currentView = 'cards';

        function formatCurrency(num) {
            return '$' + num.toLocaleString('es-AR');
        }

        function normalizeGestion(g) {
            return g.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/ó/g, 'o');
        }

        function getGestionClass(gestion) {
            const normalized = normalizeGestion(gestion);
            if (normalized.includes('fidelizacion')) return 'fidelizacion';
            if (normalized.includes('relacionamiento')) return 'relacionamiento';
            if (normalized.includes('comunicacion')) return 'comunicacion';
            if (normalized.includes('branding')) return 'branding';
            return 'varios';
        }

        function getGestionColor(gestion) {
            const cls = getGestionClass(gestion);
            const colors = {
                fidelizacion: '#00d4aa',
                relacionamiento: '#6366f1',
                comunicacion: '#f59e0b',
                branding: '#ec4899',
                varios: '#8b5cf6'
            };
            return colors[cls] || colors.varios;
        }

        function filterActivities() {
            return activities.filter(a => {
                // Filtro por gestión
                const gestionMatch = currentFilters.gestion === 'all' || 
                    getGestionClass(a.gestion) === currentFilters.gestion;
                
                // Filtro por tipo
                let tipoMatch = currentFilters.tipo === 'all';
                if (!tipoMatch) {
                    const tipoLower = a.tipo.toLowerCase();
                    if (currentFilters.tipo === 'evento-mayor') tipoMatch = tipoLower === 'evento mayor';
                    if (currentFilters.tipo === 'evento-menor') tipoMatch = tipoLower === 'evento menor';
                    if (currentFilters.tipo === 'sponsoreo-mayor') tipoMatch = tipoLower === 'sponsoreo mayor';
                    if (currentFilters.tipo === 'sponsoreo-menor') tipoMatch = tipoLower === 'sponsoreo menor';
                    if (currentFilters.tipo === 'networking') tipoMatch = tipoLower.includes('networking');
                    if (currentFilters.tipo === 'sales') tipoMatch = tipoLower.includes('sales');
                    if (currentFilters.tipo === 'research') tipoMatch = tipoLower.includes('research');
                    if (currentFilters.tipo === 'pr') tipoMatch = tipoLower.includes('pr') && !tipoLower.includes('produccion');
                    if (currentFilters.tipo === 'produccion') tipoMatch = tipoLower.includes('produccion');
                    if (currentFilters.tipo === 'content') tipoMatch = tipoLower.includes('content');
                    if (currentFilters.tipo === 'pauta') tipoMatch = tipoLower.includes('pauta');
                }
                
                // Filtro por frecuencia
                let frecuenciaMatch = currentFilters.frecuencia === 'all';
                if (!frecuenciaMatch) {
                    const freqLower = a.frecuencia.toLowerCase();
                    if (currentFilters.frecuencia === 'anual') frecuenciaMatch = freqLower.includes('anual');
                    if (currentFilters.frecuencia === 'semestral') frecuenciaMatch = freqLower.includes('semestral');
                    if (currentFilters.frecuencia === 'trimestral') frecuenciaMatch = freqLower.includes('trimestral');
                    if (currentFilters.frecuencia === 'bimestral') frecuenciaMatch = freqLower.includes('bimestral');
                    if (currentFilters.frecuencia === 'mensual') frecuenciaMatch = freqLower.includes('mensual');
                    if (currentFilters.frecuencia === 'continuo') frecuenciaMatch = freqLower.includes('continuo') || freqLower.includes('semanal');
                    if (currentFilters.frecuencia === 'eventual') frecuenciaMatch = freqLower.includes('eventual');
                    if (currentFilters.frecuencia === 'quincenal') frecuenciaMatch = freqLower.includes('quincenal');
                    if (currentFilters.frecuencia === 'ondemand') frecuenciaMatch = freqLower.includes('ondemand');
                }
                
                // Filtro por búsqueda de texto
                let searchMatch = true;
                if (currentFilters.search && currentFilters.search.length > 0) {
                    const searchTerm = currentFilters.search.toLowerCase();
                    searchMatch = a.actividad.toLowerCase().includes(searchTerm) ||
                                  a.tipo.toLowerCase().includes(searchTerm) ||
                                  a.gestion.toLowerCase().includes(searchTerm);
                }
                
                return gestionMatch && tipoMatch && frecuenciaMatch && searchMatch;
            });
        }

        function renderActivityCard(activity) {
            const gestionClass = getGestionClass(activity.gestion);
            const percentage = ((activity.inversion / totalInversion) * 100).toFixed(1);
            const titleText = highlightText(activity.actividad, currentFilters.search);
            
            return `
                <div class="activity-card ${gestionClass}" onclick="openModal(${activity.id})">
                    <div class="card-header">
                        <span class="card-type">${activity.tipo}</span>
                        <span class="card-investment">${formatCurrency(activity.inversion)}</span>
                    </div>
                    <h4 class="card-title">${titleText}</h4>
                    <div class="card-meta">
                        <span>${activity.frecuencia.split('- ')[1]}</span>
                        <span>${percentage}% del total</span>
                    </div>
                    <div class="gantt-mini">
                        ${activity.meses.map((m, i) => {
                            let cls = 'gantt-month';
                            if (m === 1) cls += ' active';
                            else if (m === 2 || activity.tentative) cls += ' tentative';
                            else if (m === 3 || activity.ondemand) cls += ' ondemand';
                            return `<div class="${cls}" title="${months[i]}">${months[i][0]}</div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderActiveFilters() {
            const container = document.getElementById('active-filters');
            const tags = [];
            
            if (currentFilters.gestion !== 'all') {
                const label = currentFilters.gestion.charAt(0).toUpperCase() + currentFilters.gestion.slice(1);
                tags.push({ type: 'gestion', label: `Gestión: ${label}`, value: currentFilters.gestion });
            }
            
            if (currentFilters.tipo !== 'all') {
                const label = currentFilters.tipo.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                tags.push({ type: 'tipo', label: `Tipo: ${label}`, value: currentFilters.tipo });
            }
            
            if (currentFilters.frecuencia !== 'all') {
                const label = currentFilters.frecuencia.charAt(0).toUpperCase() + currentFilters.frecuencia.slice(1);
                tags.push({ type: 'frecuencia', label: `Frecuencia: ${label}`, value: currentFilters.frecuencia });
            }
            
            if (currentFilters.search && currentFilters.search.length > 0) {
                tags.push({ type: 'search', label: `Búsqueda: "${currentFilters.search}"`, value: currentFilters.search });
            }
            
            if (tags.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = tags.map(tag => `
                <span class="filter-tag">
                    ${tag.label}
                    <button class="filter-tag-remove" data-type="${tag.type}">✕</button>
                </span>
            `).join('') + `
                <button class="filter-tag" style="cursor: pointer; border-color: var(--accent-relacionamiento);" id="clear-all-filters">
                    Limpiar todos
                </button>
            `;
            
            // Event listeners para remover filtros
            container.querySelectorAll('.filter-tag-remove').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    if (type === 'search') {
                        currentFilters.search = '';
                        document.getElementById('activity-search').value = '';
                        document.getElementById('search-clear').classList.remove('visible');
                    } else {
                        currentFilters[type] = 'all';
                        document.querySelectorAll(`#${type}-filter .filter-btn`).forEach(b => b.classList.remove('active'));
                        document.querySelector(`#${type}-filter .filter-btn[data-filter="all"]`).classList.add('active');
                    }
                    render();
                });
            });
            
            document.getElementById('clear-all-filters')?.addEventListener('click', () => {
                currentFilters = { gestion: 'all', tipo: 'all', frecuencia: 'all', search: '' };
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.filter-btn[data-filter="all"]').forEach(b => b.classList.add('active'));
                document.getElementById('activity-search').value = '';
                document.getElementById('search-clear').classList.remove('visible');
                render();
            });
        }

        function highlightText(text, search) {
            if (!search || search.length === 0) return text;
            const regex = new RegExp(`(${search})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function renderCardsView() {
            const filtered = filterActivities();
            const grid = document.getElementById('activity-grid');
            const totalFiltered = filtered.reduce((sum, a) => sum + a.inversion, 0);
            
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p>No hay actividades con los filtros seleccionados</p>
                    </div>
                `;
                return;
            }
            
            const resultsInfo = (currentFilters.gestion !== 'all' || currentFilters.tipo !== 'all' || 
                                 currentFilters.frecuencia !== 'all' || currentFilters.search) 
                ? `<div class="results-count" style="grid-column: 1 / -1;">
                     Mostrando <strong>${filtered.length}</strong> actividades · 
                     Inversión filtrada: <strong>${formatCurrency(totalFiltered)}</strong> 
                     (${((totalFiltered / totalInversion) * 100).toFixed(1)}% del total)
                   </div>` 
                : '';
            
            grid.innerHTML = resultsInfo + filtered
                .sort((a, b) => b.inversion - a.inversion)
                .map(renderActivityCard)
                .join('');
        }

        function renderTableView() {
            const filtered = filterActivities();
            const tbody = document.getElementById('table-body');
            const total = filtered.reduce((sum, a) => sum + a.inversion, 0);
            
            tbody.innerHTML = filtered
                .sort((a, b) => b.inversion - a.inversion)
                .map(a => {
                    const gestionClass = getGestionClass(a.gestion);
                    const percentage = ((a.inversion / total) * 100).toFixed(2);
                    const actividadText = highlightText(a.actividad, currentFilters.search);
                    return `
                        <tr>
                            <td><span class="gestion-badge ${gestionClass}">${a.gestion}</span></td>
                            <td>${a.tipo}</td>
                            <td style="cursor: pointer;" onclick="openModal(${a.id})">${actividadText}</td>
                            <td>${a.frecuencia.split('- ')[1]}</td>
                            <td>
                                <input type="number" 
                                       class="editable-input" 
                                       value="${a.inversion}" 
                                       onchange="updateInversion(${a.id}, this.value)"
                                       onclick="event.stopPropagation(); this.select();"
                                >
                            </td>
                            <td>
                                ${percentage}%
                                <span class="percentage-bar">
                                    <span class="percentage-bar-fill" style="width: ${Math.min(percentage * 5, 100)}%; background: ${getGestionColor(a.gestion)}"></span>
                                </span>
                            </td>
                        </tr>
                    `;
                })
                .join('');
        }

        function renderMonthView() {
            const filtered = filterActivities();
            const grid = document.getElementById('month-grid');
            
            // Separar actividades confirmadas de eventuales
            // CONFIRMADAS: tienen al menos un mes con valor 1
            // EVENTUALES: solo tienen meses con valor 2 o 3 (sin fecha definida)
            
            let totalEventuales = 0;
            const actividadesEventuales = [];
            
            filtered.forEach(a => {
                const tieneConfirmados = a.meses.some(m => m === 1);
                if (!tieneConfirmados && a.meses.some(m => m === 2 || m === 3)) {
                    // Es 100% eventual, no tiene ningún mes confirmado
                    totalEventuales += a.inversion;
                    actividadesEventuales.push(a);
                }
            });
            
            // Calcular inversión por mes (SOLO CONFIRMADAS)
            const monthData = months.map((month, idx) => {
                const confirmedActivities = [];
                let confirmedTotal = 0;
                
                filtered.forEach(a => {
                    const mesValue = a.meses[idx];
                    
                    if (mesValue === 1) {
                        // CONFIRMADA en este mes: prorratear entre meses confirmados
                        const confirmedMesesCount = a.meses.filter(m => m === 1).length;
                        const monthlyValue = confirmedMesesCount > 0 ? a.inversion / confirmedMesesCount : 0;
                        
                        confirmedActivities.push({
                            ...a,
                            monthlyValue: Math.round(monthlyValue)
                        });
                        confirmedTotal += monthlyValue;
                    }
                });
                
                return { 
                    month, 
                    index: idx + 1,
                    activities: confirmedActivities.sort((a, b) => b.monthlyValue - a.monthlyValue),
                    total: Math.round(confirmedTotal),
                    count: confirmedActivities.length
                };
            });
            
            // Calcular totales
            const totalConfirmado = monthData.reduce((sum, m) => sum + m.total, 0);
            const presupuestoTotal = 1450000;
            
            // Actualizar header
            document.getElementById('month-budget-total').textContent = formatCurrency(presupuestoTotal);
            document.getElementById('month-confirmed-total').textContent = formatCurrency(totalConfirmado);
            document.getElementById('month-eventual-total').textContent = formatCurrency(totalEventuales);
            
            // Calcular acumulado mes a mes
            let acumulado = 0;
            
            grid.innerHTML = monthData.map((m, idx) => {
                acumulado += m.total;
                const porcentajeAvance = ((acumulado / presupuestoTotal) * 100).toFixed(1);
                
                return `
                <div class="month-card">
                    <div class="month-card-header">
                        <h4>${m.month}</h4>
                        <span class="month-index">${m.index}/12</span>
                    </div>
                    <div class="month-total">${formatCurrency(m.total)}</div>
                    <div class="month-accumulated">Acum: ${formatCurrency(acumulado)} (${porcentajeAvance}%)</div>
                    <div class="month-count">${m.count} actividad${m.count !== 1 ? 'es' : ''}</div>
                    <div class="month-activities">
                        ${m.activities.length ? m.activities.map(a => {
                            const gestionClass = getGestionClass(a.gestion);
                            return `
                                <div class="month-activity" onclick="openModal(${a.id})">
                                    <div class="month-activity-info">
                                        <div class="month-activity-name">${a.actividad}</div>
                                        <span class="month-activity-badge ${gestionClass}">${a.gestion}</span>
                                    </div>
                                    <span class="month-activity-value">${formatCurrency(a.monthlyValue)}</span>
                                </div>
                            `;
                        }).join('')
                        : '<div class="month-empty">Sin actividades</div>'
                        }
                    </div>
                </div>
            `}).join('');
        }

        function renderBreakdowns() {
            const filtered = filterActivities();
            
            // Por Gestión
            const gestionData = {};
            filtered.forEach(a => {
                const key = a.gestion;
                gestionData[key] = (gestionData[key] || 0) + a.inversion;
            });
            
            const gestionBreakdown = document.getElementById('gestion-breakdown');
            gestionBreakdown.innerHTML = Object.entries(gestionData)
                .sort((a, b) => b[1] - a[1])
                .map(([key, value]) => {
                    const percentage = ((value / totalInversion) * 100).toFixed(1);
                    const color = getGestionColor(key);
                    return `
                        <div class="breakdown-item">
                            <div>
                                <span class="breakdown-label">
                                    <span class="breakdown-dot" style="background: ${color}"></span>
                                    ${key}
                                </span>
                                <div class="breakdown-bar">
                                    <div class="breakdown-bar-fill" style="width: ${percentage}%; background: ${color}"></div>
                                </div>
                            </div>
                            <span class="breakdown-value">${formatCurrency(value)}</span>
                        </div>
                    `;
                }).join('');
            
            // Por Tipo
            const tipoData = {};
            filtered.forEach(a => {
                const key = a.tipo;
                tipoData[key] = (tipoData[key] || 0) + a.inversion;
            });
            
            const tipoBreakdown = document.getElementById('tipo-breakdown');
            tipoBreakdown.innerHTML = Object.entries(tipoData)
                .sort((a, b) => b[1] - a[1])
                .map(([key, value]) => {
                    const percentage = ((value / totalInversion) * 100).toFixed(1);
                    return `
                        <div class="breakdown-item">
                            <div>
                                <span class="breakdown-label">${key}</span>
                                <div class="breakdown-bar">
                                    <div class="breakdown-bar-fill" style="width: ${percentage}%; background: var(--accent-relacionamiento)"></div>
                                </div>
                            </div>
                            <span class="breakdown-value">${formatCurrency(value)}</span>
                        </div>
                    `;
                }).join('');
            
            // Por Frecuencia
            const freqData = {};
            filtered.forEach(a => {
                const key = a.frecuencia.split('- ')[1];
                freqData[key] = (freqData[key] || 0) + a.inversion;
            });
            
            const freqBreakdown = document.getElementById('frecuencia-breakdown');
            freqBreakdown.innerHTML = Object.entries(freqData)
                .sort((a, b) => b[1] - a[1])
                .map(([key, value]) => {
                    const percentage = ((value / totalInversion) * 100).toFixed(1);
                    return `
                        <div class="breakdown-item">
                            <div>
                                <span class="breakdown-label">${key}</span>
                                <div class="breakdown-bar">
                                    <div class="breakdown-bar-fill" style="width: ${percentage}%; background: var(--accent-fidelizacion)"></div>
                                </div>
                            </div>
                            <span class="breakdown-value">${formatCurrency(value)}</span>
                        </div>
                    `;
                }).join('');
        }

        function updateKPIs() {
            const filtered = filterActivities();
            const total = filtered.reduce((sum, a) => sum + a.inversion, 0);
            
            document.getElementById('total-investment').textContent = formatCurrency(total);
            document.getElementById('total-activities').textContent = filtered.length;
            document.getElementById('avg-monthly').textContent = formatCurrency(Math.round(total / 12));
        }

        function render() {
            updateKPIs();
            renderBreakdowns();
            renderActiveFilters();
            initCharts();
            
            document.getElementById('activity-grid').classList.toggle('hidden', currentView !== 'cards');
            document.getElementById('table-view').classList.toggle('active', currentView === 'table');
            document.getElementById('month-view').classList.toggle('active', currentView === 'months');
            
            if (currentView === 'cards') renderCardsView();
            else if (currentView === 'table') renderTableView();
            else if (currentView === 'months') renderMonthView();
        }

        // Event listeners
        document.getElementById('gestion-filter').addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('#gestion-filter .filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilters.gestion = e.target.dataset.filter;
                render();
            }
        });

        document.getElementById('tipo-filter').addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('#tipo-filter .filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilters.tipo = e.target.dataset.filter;
                render();
            }
        });

        document.getElementById('frecuencia-filter').addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('#frecuencia-filter .filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilters.frecuencia = e.target.dataset.filter;
                render();
            }
        });

        // Search functionality
        const searchInput = document.getElementById('activity-search');
        const searchClear = document.getElementById('search-clear');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const value = e.target.value.trim();
            
            searchClear.classList.toggle('visible', value.length > 0);
            
            searchTimeout = setTimeout(() => {
                currentFilters.search = value;
                render();
            }, 300);
        });

        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            currentFilters.search = '';
            searchClear.classList.remove('visible');
            render();
        });

        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                render();
            });
        });

        // Chart.js configuration
        Chart.defaults.color = '#8888a0';
        Chart.defaults.borderColor = '#2a2a3a';
        Chart.defaults.font.family = "'DM Sans', sans-serif";

        const chartColors = {
            fidelizacion: '#00d4aa',
            relacionamiento: '#6366f1',
            comunicacion: '#f59e0b',
            branding: '#ec4899',
            varios: '#8b5cf6'
        };

        let charts = {};

        function calculateMonthlyByGestion(filtered) {
            const data = {
                fidelizacion: Array(12).fill(0),
                relacionamiento: Array(12).fill(0),
                comunicacion: Array(12).fill(0),
                branding: Array(12).fill(0),
                varios: Array(12).fill(0)
            };
            
            filtered.forEach(a => {
                const gestion = getGestionClass(a.gestion);
                const activeMeses = a.meses.filter(m => m === 1).length;
                if (activeMeses > 0) {
                    const monthlyValue = a.inversion / activeMeses;
                    a.meses.forEach((m, idx) => {
                        if (m === 1) {
                            data[gestion][idx] += monthlyValue;
                        }
                    });
                }
            });
            
            return data;
        }

        // Estructura para guardar actividades por mes (para tooltips)
        let monthlyActivitiesData = [];

        function calculateMonthlyActivities(filtered) {
            monthlyActivitiesData = months.map((month, idx) => {
                const activitiesInMonth = [];
                
                filtered.forEach(a => {
                    if (a.meses[idx] === 1) {
                        const activeMeses = a.meses.filter(m => m === 1).length;
                        const monthlyValue = activeMeses > 0 ? a.inversion / activeMeses : 0;
                        activitiesInMonth.push({
                            nombre: a.actividad,
                            gestion: a.gestion,
                            valor: Math.round(monthlyValue)
                        });
                    }
                });
                
                return activitiesInMonth.sort((a, b) => b.valor - a.valor);
            });
        }

        function initCharts() {
            const filtered = filterActivities();
            const monthlyData = calculateMonthlyByGestion(filtered);
            calculateMonthlyActivities(filtered);
            
            // Monthly Stacked Bar Chart
            const monthlyCtx = document.getElementById('monthlyStackedChart').getContext('2d');
            if (charts.monthly) charts.monthly.destroy();
            
            charts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Fidelización',
                            data: monthlyData.fidelizacion,
                            backgroundColor: chartColors.fidelizacion,
                            borderRadius: 4,
                            borderSkipped: false
                        },
                        {
                            label: 'Relacionamiento',
                            data: monthlyData.relacionamiento,
                            backgroundColor: chartColors.relacionamiento,
                            borderRadius: 4,
                            borderSkipped: false
                        },
                        {
                            label: 'Comunicación',
                            data: monthlyData.comunicacion,
                            backgroundColor: chartColors.comunicacion,
                            borderRadius: 4,
                            borderSkipped: false
                        },
                        {
                            label: 'Branding',
                            data: monthlyData.branding,
                            backgroundColor: chartColors.branding,
                            borderRadius: 4,
                            borderSkipped: false
                        },
                        {
                            label: 'Varios',
                            data: monthlyData.varios,
                            backgroundColor: chartColors.varios,
                            borderRadius: 4,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const monthIndex = elements[0].index;
                            openMonthDetailModal(monthIndex);
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#12121a',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            padding: 16,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 12 },
                            bodySpacing: 6,
                            footerFont: { size: 10, style: 'italic' },
                            callbacks: {
                                title: function(context) {
                                    const monthIndex = context[0].dataIndex;
                                    const total = monthlyActivitiesData[monthIndex].reduce((sum, a) => sum + a.valor, 0);
                                    return months[monthIndex] + ' - Total: ' + formatCurrency(total);
                                },
                                label: function(context) {
                                    return null;
                                },
                                afterBody: function(context) {
                                    const monthIndex = context[0].dataIndex;
                                    const activities = monthlyActivitiesData[monthIndex];
                                    
                                    if (activities.length === 0) return ['Sin actividades'];
                                    
                                    const lines = [];
                                    activities.slice(0, 8).forEach(a => {
                                        const nombre = a.nombre.length > 25 ? a.nombre.substring(0, 25) + '...' : a.nombre;
                                        lines.push(`${nombre}: ${formatCurrency(a.valor)}`);
                                    });
                                    
                                    if (activities.length > 8) {
                                        lines.push(`... y ${activities.length - 8} más`);
                                    }
                                    
                                    return lines;
                                },
                                footer: function() {
                                    return '👆 Click para ver detalle completo';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false }
                        },
                        y: {
                            stacked: true,
                            grid: { color: '#1a1a24' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });

            // Pie Chart for Gestion
            const gestionTotals = {};
            filtered.forEach(a => {
                const g = getGestionClass(a.gestion);
                gestionTotals[g] = (gestionTotals[g] || 0) + a.inversion;
            });

            const pieCtx = document.getElementById('gestionPieChart').getContext('2d');
            if (charts.pie) charts.pie.destroy();
            
            const pieLabels = Object.keys(gestionTotals);
            const pieData = Object.values(gestionTotals);
            const pieColors = pieLabels.map(l => chartColors[l]);
            
            charts.pie = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: pieLabels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: pieData,
                        backgroundColor: pieColors,
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a24',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((context.raw / total) * 100).toFixed(1);
                                    return formatCurrency(context.raw) + ' (' + pct + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Update insight
            const topGestion = Object.entries(gestionTotals).sort((a, b) => b[1] - a[1])[0];
            if (topGestion) {
                document.getElementById('top-gestion-insight').textContent = 
                    topGestion[0].charAt(0).toUpperCase() + topGestion[0].slice(1) + ' lidera';
                document.getElementById('top-gestion-detail').textContent = 
                    formatCurrency(topGestion[1]) + ' (' + ((topGestion[1] / totalInversion) * 100).toFixed(1) + '% del total)';
            }

            // Cumulative Chart
            const monthlyTotals = months.map((_, idx) => {
                return Object.values(monthlyData).reduce((sum, arr) => sum + arr[idx], 0);
            });
            
            const cumulative = monthlyTotals.reduce((acc, val, idx) => {
                acc.push((acc[idx - 1] || 0) + val);
                return acc;
            }, []);

            // Update cumulative stats
            const total = filtered.reduce((sum, a) => sum + a.inversion, 0);
            document.getElementById('q1-total').textContent = formatCurrency(Math.round(cumulative[2] || 0));
            document.getElementById('h1-total').textContent = formatCurrency(Math.round(cumulative[5] || 0));
            document.getElementById('year-total').textContent = formatCurrency(total);

            const cumCtx = document.getElementById('cumulativeChart').getContext('2d');
            if (charts.cumulative) charts.cumulative.destroy();
            
            charts.cumulative = new Chart(cumCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Inversión Acumulada',
                            data: cumulative,
                            borderColor: chartColors.relacionamiento,
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Presupuesto Total',
                            data: Array(12).fill(total),
                            borderColor: '#4a4a5a',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Inversión Mensual',
                            data: monthlyTotals,
                            type: 'bar',
                            backgroundColor: 'rgba(0, 212, 170, 0.5)',
                            borderRadius: 4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a24',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(Math.round(context.raw));
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            position: 'left',
                            grid: { color: '#1a1a24' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        },
                        y1: {
                            position: 'right',
                            grid: { display: false },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });

            // Tipo Bar Chart (Horizontal)
            const tipoTotals = {};
            filtered.forEach(a => {
                tipoTotals[a.tipo] = (tipoTotals[a.tipo] || 0) + a.inversion;
            });
            
            const sortedTipos = Object.entries(tipoTotals).sort((a, b) => b[1] - a[1]);

            const tipoCtx = document.getElementById('tipoBarChart').getContext('2d');
            if (charts.tipo) charts.tipo.destroy();
            
            charts.tipo = new Chart(tipoCtx, {
                type: 'bar',
                data: {
                    labels: sortedTipos.map(t => t[0]),
                    datasets: [{
                        data: sortedTipos.map(t => t[1]),
                        backgroundColor: sortedTipos.map((_, i) => {
                            const colors = [chartColors.relacionamiento, chartColors.fidelizacion, chartColors.comunicacion, chartColors.branding, chartColors.varios];
                            return colors[i % colors.length];
                        }),
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a24',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const pct = ((context.raw / total) * 100).toFixed(1);
                                    return formatCurrency(context.raw) + ' (' + pct + '%)';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#1a1a24' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'k';
                                }
                            }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Frequency Radar Chart
            const freqTotals = {};
            filtered.forEach(a => {
                const freq = a.frecuencia.split('- ')[1];
                freqTotals[freq] = (freqTotals[freq] || 0) + a.inversion;
            });

            const sortedFreqs = Object.entries(freqTotals).sort((a, b) => b[1] - a[1]);
            
            const freqCtx = document.getElementById('frequencyChart').getContext('2d');
            if (charts.frequency) charts.frequency.destroy();
            
            charts.frequency = new Chart(freqCtx, {
                type: 'polarArea',
                data: {
                    labels: sortedFreqs.map(f => f[0]),
                    datasets: [{
                        data: sortedFreqs.map(f => f[1]),
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.7)',
                            'rgba(0, 212, 170, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(236, 72, 153, 0.7)',
                            'rgba(139, 92, 246, 0.7)',
                            'rgba(99, 102, 241, 0.4)',
                            'rgba(0, 212, 170, 0.4)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a24',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            grid: { color: '#2a2a3a' },
                            ticks: { display: false }
                        }
                    }
                }
            });

            // Update frequency insight
            if (sortedFreqs.length > 0) {
                const topFreq = sortedFreqs[0];
                document.getElementById('freq-insight').textContent = topFreq[0] + ' concentra más inversión';
                document.getElementById('freq-detail').textContent = formatCurrency(topFreq[1]) + ' del presupuesto total';
            }
        }

        // Chart tab switching
        document.querySelectorAll('.chart-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const view = tab.dataset.chart;
                document.getElementById('charts-monthly').style.display = view === 'monthly' ? 'grid' : 'none';
                document.getElementById('charts-cumulative').style.display = view === 'cumulative' ? 'grid' : 'none';
                document.getElementById('charts-comparison').style.display = view === 'comparison' ? 'grid' : 'none';
            });
        });

        // Initial render
        render();

        // ==========================================
        // MODAL DE DETALLE MENSUAL (zoom de barra)
        // ==========================================
        let monthDetailChart = null;

        window.openMonthDetailModal = function(monthIndex) {
            const activities = monthlyActivitiesData[monthIndex];
            const total = activities.reduce((sum, a) => sum + a.valor, 0);
            
            document.getElementById('month-modal-title').textContent = `Detalle de ${months[monthIndex]} 2026`;
            document.getElementById('month-modal-total').textContent = formatCurrency(total);
            
            // Crear gráfico de dona con todas las actividades
            const ctx = document.getElementById('monthDetailChart').getContext('2d');
            if (monthDetailChart) monthDetailChart.destroy();
            
            // Generar colores para cada actividad basados en su gestión
            const activityColors = activities.map(a => {
                const gestionClass = getGestionClass(a.gestion);
                return chartColors[gestionClass] || chartColors.varios;
            });
            
            monthDetailChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: activities.map(a => a.nombre.length > 20 ? a.nombre.substring(0, 20) + '...' : a.nombre),
                    datasets: [{
                        data: activities.map(a => a.valor),
                        backgroundColor: activityColors,
                        borderWidth: 2,
                        borderColor: '#12121a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '50%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a24',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const pct = ((context.raw / total) * 100).toFixed(1);
                                    return `${formatCurrency(context.raw)} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Lista de actividades
            const listContainer = document.getElementById('month-modal-list');
            listContainer.innerHTML = activities.map(a => {
                const gestionClass = getGestionClass(a.gestion);
                const color = chartColors[gestionClass] || chartColors.varios;
                const pct = ((a.valor / total) * 100).toFixed(1);
                const activityObj = activities.find(act => act.nombre === a.nombre);
                
                return `
                    <div class="month-modal-item" onclick="closeMonthModal(); openModalByName('${a.nombre.replace(/'/g, "\\'")}')">
                        <div class="month-modal-item-info">
                            <div class="month-modal-item-color" style="background: ${color}"></div>
                            <span class="month-modal-item-name">${a.nombre}</span>
                            <span class="month-modal-item-gestion">${a.gestion}</span>
                        </div>
                        <span class="month-modal-item-value">${formatCurrency(a.valor)}</span>
                        <span class="month-modal-item-percent">${pct}%</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('month-detail-modal').classList.add('open');
        };

        window.closeMonthModal = function() {
            document.getElementById('month-detail-modal').classList.remove('open');
        };

        window.openModalByName = function(nombre) {
            const activity = activities.find(a => a.actividad === nombre);
            if (activity) {
                openModal(activity.id);
            }
        };

        // Click fuera del modal para cerrar
        document.getElementById('month-detail-modal').addEventListener('click', function(e) {
            if (e.target === this) closeMonthModal();
        });

        // ==========================================
        // MODAL DE DETALLE DE ACTIVIDAD
        // ==========================================
        let currentModalId = null;

        window.openModal = function(id) {
            const item = activities.find(a => a.id === id);
            if (!item) return;
            
            currentModalId = id;
            const gestionClass = getGestionClass(item.gestion);
            
            document.getElementById('modal-title').textContent = item.actividad;
            
            const badge = document.getElementById('modal-gestion-badge');
            badge.textContent = item.gestion;
            badge.className = 'modal-gestion-badge';
            badge.style.background = `var(--glow-${gestionClass === 'fidelizacion' ? 'fidelizacion' : 'relacionamiento'})`;
            badge.style.color = getGestionColor(item.gestion);
            
            document.getElementById('modal-tipo').textContent = item.tipo;
            document.getElementById('modal-frecuencia').textContent = item.frecuencia;
            document.getElementById('modal-unidad').textContent = formatCurrency(item.unidad);
            document.getElementById('modal-cantidad').textContent = item.cantidad;
            document.getElementById('modal-inversion').value = item.inversion;
            
            // Gantt en modal
            const ganttContainer = document.getElementById('modal-gantt');
            ganttContainer.innerHTML = item.meses.map((m, i) => {
                let cls = 'modal-gantt-month';
                if (m === 1) cls += ' active';
                else if (m === 2) cls += ' tentative';
                return `<div class="${cls}">${months[i]}</div>`;
            }).join('');
            
            document.getElementById('detail-modal').classList.add('open');
        };

        window.closeModal = function() {
            document.getElementById('detail-modal').classList.remove('open');
            currentModalId = null;
        };

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') closeModal();
        });

        // Click fuera del modal para cerrar
        document.getElementById('detail-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Editar inversión desde modal
        document.getElementById('modal-inversion').addEventListener('change', function() {
            if (currentModalId !== null) {
                updateInversion(currentModalId, this.value);
            }
        });

        // ==========================================
        // EDICIÓN EN TIEMPO REAL
        // ==========================================
        window.updateInversion = function(id, newValue) {
            const index = activities.findIndex(a => a.id === id);
            if (index !== -1) {
                activities[index].inversion = parseInt(newValue) || 0;
                // Recalcular total
                totalInversion = activities.reduce((sum, a) => sum + a.inversion, 0);
                render();
            }
        };

        // ==========================================
        // EXPORTAR A CSV
        // ==========================================
        document.getElementById('btn-export').addEventListener('click', function() {
            const data = filterActivities();
            
            // Header
            let csv = '\uFEFF'; // BOM para UTF-8
            csv += 'Gestión,Actividad,Tipo,Frecuencia,Unidad,Cantidad,Inversión,Meses Activos\n';
            
            // Data
            data.forEach(a => {
                const activeMonths = a.meses
                    .map((m, i) => m ? months[i] : null)
                    .filter(x => x)
                    .join(' | ');
                
                csv += `"${a.gestion}","${a.actividad}","${a.tipo}","${a.frecuencia}",${a.unidad},${a.cantidad},${a.inversion},"${activeMonths}"\n`;
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `plan_accion_2026_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
    </div><!-- END main-content -->
    
    <script>
    // ========== PASSWORD PROTECTION ==========
    const CLAVE = 'F2026';
    
    function checkPassword() {
        const input = document.getElementById('password-input').value;
        if (input === CLAVE) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-content').classList.add('visible');
            sessionStorage.setItem('authenticated', 'true');
        } else {
            document.getElementById('login-error').style.display = 'block';
            document.getElementById('password-input').value = '';
        }
    }
    
    // Mantener sesión si ya se autenticó
    if (sessionStorage.getItem('authenticated') === 'true') {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-content').classList.add('visible');
    }
    </script>
</body>
</html>
